name: Build ZMK firmware
on:
  push:
    paths:
      - '**.keymap'
      - '**.conf'
      - '**.dtsi'
      - '**.overlay'
      - '**/build.yaml'
      - 'west.yml'
      - '.github/workflows/**'
  pull_request:
    paths:
      - '**.keymap'
      - '**.conf'
      - '**.dtsi'
      - '**.overlay'
      - '**/build.yaml'
      - 'west.yml'
      - '.github/workflows/**'
  workflow_dispatch:

jobs:
  build:
    strategy:
      fail-fast: false
      matrix:
        include:
          - variant: mac_onishi
            path: mac_onishi
          - variant: mac_qwerty
            path: mac_qwerty
          - variant: win_onishi
            path: win_onishi
          - variant: win_qwerty
            path: win_qwerty
    uses: ./.github/workflows/zmk_build_fixed.yml
    with:
      config_path: ${{ matrix.path }}
      build_matrix_path: ${{ matrix.path }}/build.yaml
      archive_name: toucan_${{ matrix.variant }}

  deploy:
    needs: build
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download Artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts
          pattern: artifact-*
          merge-multiple: true

      - name: Move artifacts to root
        run: |
          ls -R artifacts
          find artifacts -name "*.uf2" -exec mv {} . \;
          rm -rf artifacts
          ls -la *.uf2

      - name: Commit and Push
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git add *.uf2
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "chore: update firmware [skip ci]"
            # 現在のブランチにプッシュ
            git push origin HEAD:${GITHUB_REF#refs/heads/}
          fi
